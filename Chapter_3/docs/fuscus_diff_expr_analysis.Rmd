---
title: "Differential Expression Analysis in _Syngnathus fuscus_"
author: "Coley Tosto"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: true
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='../',fig_path="../imgs/")
```

``` {r library, include = TRUE, message = FALSE, warning = FALSE}
#This is a cohesive list of all the libraries used in this document
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
library(spfTools)
library(ggpubr)
library(cowplot)
library(UpSetR)
library(ggplot2)
library(kableExtra)
library(tidyverse)
library(knitr)
```

``` {r read-data}
#The abundance matrix generated via salmon and tximport to be used for the DE analysis
FU_txi.salmon <- readRDS("data/txi.salmon_FU.RDS")

#The samples file generated for tximport
FU_samples <- read.table("FU_samples.txt", header = TRUE)

#Make sure the conditions are in the samples file as a factor
FU_samples$Sex <- as.factor(FU_samples$Sex)
FU_samples$Organ <- as.factor(FU_samples$Organ)

```

The package `DESeq2` was used for the differential expression analysis outlined below.

# Single factor analysis - Comparing Males v Females
I am starting with a sing factor analysis to look at overall differences between male and female expression across th organs and to do some exploratory analysis of the data. To analyze your data with DESeq2 you must first generate the DESeqDataSet. In order to do this we need the abundance matrix generated with `tximport` and a `samples` file that lays out all of the conditions.

```{r DESeqDataSet, message=FALSE, warning=FALSE}
#Create the DESeq dataset
dds_FU <- DESeqDataSetFromTximport(FU_txi.salmon, 
                                   colData = FU_samples,
                                   design = ~ Sex)

```

The data is then pre-filtered to remove low gene counts before running further DESeq2 functions. By doing this we remove rows in which there are very few reads thus reducing the memory size of the `dds` object and increasing the speed at which we can use the transformation and testing functions in DESeq2.

The cutoff used here was to remove reads that had a count of less than 10 in each row

```{r pre-filtering, message=FALSE, warning=FALSE}
#only keeping rows that have at lead 10 reads total
keep <- rowSums(counts(dds_FU)) >= 10
dds_FU <- dds_FU[keep, ]

```

After filtering we can now perform the standard differential expression analysis that is wrapped into DESeq2.

```{r diff-exp, message=FALSE, warning=FALSE}
#Generate the expression values
dds_FU_exp <- DESeq(dds_FU)

#Compile the results
res <- results(dds_FU_exp)
res
```

Once that has finished we can now start exploring some of the single-factor analysis results.

```{r investigate-DESeq-results-SF}
summary(res)

#How many ADJUSTED p-values were less than 0.1?
sum(res$padj < 0.1, na.rm = TRUE)

#Looking at  an alpha=0.05, the default is 0.1
res05 <- results(dds_FU_exp, alpha = 0.05)
summary(res05)
sum(res05$padj < 0.05, na.rm = TRUE)

```

Looking at the summary of our results we can see that there are 2,626 male-biased genes and 2,488 female-biased genes when all of the organs are organized together. While this is informative, I am more interested in a multi-factor approach that takes into account both Sex and Tissue type. Before the multi-factor analysis, we can visualize some results from the single-factor analysis and use it for exploratory data analysis.

Interestingly, the summary is saying that there are 0 outliers, which I have a hard time believing. 

## Visualizing the results
### MA-plot - MvF Diff.
Generate an MA-plot to show the log2 fold changes attributable to sex over the mean of normalized counts for all of the samples in the `dds`. Points will be colored if the adjusted p-value is less that 0.05.

```{r MA-plot, echo=FALSE, fig.cap="LogFC versus the mean normalized count for all of the genes. Points that are blue have a p-value less than 0.05. The two plots are the same with the only difference coming from an adjusted y-limit. Points that are triangles represent genes with a fold change higher/lower than the y-limit."}

par(mfrow=c(1,2))
plotMA(res05, ylim = c(-2,2))
plotMA(res05)

```

### Heatmap - Looking at patterns of overall expression
We can also generate a heat map to look ar overall expression levels across our samples. Note, this is not differentially expressed genes.

```{r heatmap, echo=FALSEfig.cap= "Heatmap showing the expression level across all organs for the top 20 genes with the highest expression levels."}

#Pull out the top 20 rows with the most expression
select <- order(rowMeans(counts(dds_FU_exp, normalized = TRUE)),
                decreasing = TRUE)[1:20]
df <- as.data.frame(colData(dds_FU)[,c("Sex", "Organ")])

#Transform the data
vsd <- vst(dds_FU_exp, blind=FALSE)

#Run the heat map with the function pheatmap
pheatmap(assay(vsd)[select,], 
         cluster_rows = FALSE, 
         show_rownames = TRUE, 
         cluster_cols = FALSE, 
         annotation_col = df)
```

From the heatmap (Fig. \@ref(fig:heatmap)) we can see that for a lot of the top expressed genes the highest expression is found in the liver. There appears to be a few genes that are highly expressed across all tissues and a few genes that are highly expressed in the gill tissues relative to the other tissues. With this heatmap we can also pull out the names of the Trinity genes that are showing this high expression and BLAST the corresponding sequences to see what the genes are.

```{r heatmap_genes}
#Pull out the corresponding trinity_geneIDS that are plotted in the heatmap
heatmap_TG <- cbind(row.names(assay(vsd)[select,]))

#Only run once to create the file and then commented out
#write.table(heatmap_TG,
            #'FU_heatmap_trinitygenes.txt',
            #sep = "",
            #quote=FALSE,
            #row.names = FALSE,
            #col.names = FALSE)
```

### Sample-dist Heatmap
We can then generate a sample-to-sample distances heatmap that will give an overview of the similarities and differences between our samples

```{r sample-dist, echo=FALSE, fig.cap="Sample-to-sample distances heatmap showing the similarities and differences between all of the samples. The darker the color, the more similar the samples are. The diagonal line of very dark blue represents the comparissons between the same samples.", warning=FALSE}
#Calculate the sample-to-sample distances from the transformed count matrix
sampleDists <- dist(t(assay(vsd)))

#Transform into a matrix
sampleDistsMatrix <- as.matrix(sampleDists)
rownames(sampleDistsMatrix) <- paste(vsd$Sex, vsd$Organ, sep = "-")
colnames(sampleDistsMatrix) <- paste(vsd$ID)

#Run the heatmap
colors <- colorRampPalette(rev(brewer.pal(9, 'Blues')))(255)
pheatmap(sampleDistsMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists, 
         col = colors)
```

We can see that the highest similarities (aside from same samples comparisons) is between samples from the same organ (Fig. \@ref(fig:sample-dist)). After that we can see high similarities between the male gonads and the female gonads. There are also a couple samples that may be an issue for use as they are not similar to any of the other samples from the same group. This includes FUG11M4 and FUT11M4. I may end up removing all organs related to 11M4.

### PCA plots 
Next we can look at PCA plots for our samples to see how our different samples are grouping.

```{r pca-pairs-plot, echo=FALSE, fig.cap="Principal components analysis pairsplot showing PCA axis 1 - 4."}
#Generate the PCA data to create the pairs plot, using the PCAtools package
p <- pca(assay(vsd), 
         metadata = colData(dds_FU))

#Create the pairs plot
pairsplot(p,
          components = getComponents(p, c(1:4)),
          colby = "Organ",
          triangle = FALSE,
          hline = 0, vline = 0,
          colkey = c("Gill" = "#6E8B3D75", 
                     "Gonad" = "#EEB42275", 
                     "Liver" = "#EE826275"),
          shape = "Sex",
          shapekey = c(16, 17),
          pointSize = 3,
          margingaps = unit(c(0.1, 0.1, 0.1, 0.1), 'cm'),
          legendPosition = "left", legendIconSize = 3, legendLabSize = 10)

```

From the pairs plot we can see that PC1 appears to be explaining differences between the liver and the other tissues, PC2 appears to be explaining differences between gonadal and somatic tissues, PC3 seems to account for differences between male and female samples, especially in the gonads and in PC4 we can see the one problematic gill sample from above sticking out from all the rest. I am going to plot all of PC2 - 4 against PC1 below for a clearer picture.

```{r pca-plot, echo=FALSE, message=FALSE, fig.cap="Principal components analysis reflects that most variation corresponds to differences in expression between organs (green: gill; yellow: gonad; pink: liver), rather than variation due to sex (circle = female; triangle = male). The first axis explains 31% of variation in the dataset, and largely explains differences between the liver and the other tissues. The second axis explains 20% of the variation in gene expression, with somatic tissues on the opposite side of the axis from the gonads.", warning=FALSE}

#Generate the PCA dataframe
pca <- prcomp(t(assay(vsd)))
pca_plotting_data<-as.data.frame(pca$x)

#Add the metadata to the PCA dataset
pca_plotting_data$Organ <- FU_samples$Organ
pca_plotting_data$Sex <- FU_samples$Sex

#Calculate the percent variation attributed to each axis 
percentVar <- round(p$variance, digits = 2)


my_colors <- c("Gill" = "#6E8B3D75", "Gonad" = "#EEB42275", "Liver" = "#EE826275")
my_shapes <- c(16, 17)

ggplot(pca_plotting_data, aes(x=PC1, y=PC2, color = Organ, shape = Sex)) +
  scale_color_manual(values = my_colors) +
  scale_shape_manual(values = my_shapes) +
  geom_point(size = 5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_vline(xintercept = 0,
             linetype = 'dashed')
```

```{r pca1v3, echo=FALSE, fig.cap="The same Principal Components Analysis as above but with PC3. This third axis explains 10% of the variation, largely attributed to differences between the sexes, particularily in the gonads.", warning=FALSE}

ggplot(pca_plotting_data, aes(x=PC1, y=PC3, color = Organ, shape = Sex)) +
  scale_color_manual(values = my_colors) +
  scale_shape_manual(values = my_shapes) +
  geom_point(size = 5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC3: ",percentVar[3],"% variance")) + 
  coord_fixed() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_vline(xintercept = 0,
             linetype = 'dashed')
```

```{r pca1v4, echo=FALSE, fig.cap="The same Principal Components Analysis as above but with PC4. This fourth axis explains 6% of the variation, largely attributed to one of the gill samples.", warning=FALSE}

ggplot(pca_plotting_data, aes(x=PC1, y=PC4, color = Organ, shape = Sex)) +
  scale_color_manual(values = my_colors) +
  scale_shape_manual(values = my_shapes) +
  geom_point(size = 5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC4: ",percentVar[4],"% variance")) + 
  coord_fixed() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_vline(xintercept = 0,
             linetype = 'dashed')
```

# Multifactor design - Comparing M v F across the diff tissue types
If we investigate the column data of our DESeq dataset we can see that each sample has both a sex and organ type attached to it, we will be using these two factors in our multi-factor analysis. Prior to running the multi-factor analysis I am going to remove the samples that correspond to the individual 11M4.

```{r multi-factor-analysis, message=FALSE, warning=FALSE}
#Create an additional column the has the two conditions combined(sex and organ type)
FU_samples$group <- factor(paste0(FU_samples$Sex, FU_samples$Organ))

##Create a copy of the DESeq dataset
ddsMF_FU <- DESeqDataSetFromTximport(FU_txi.salmon,
                                     colData = FU_samples,
                                     design = ~ group)

##Remove all 11M4 organs from the dataset
ddsMF_FU <- ddsMF_FU[, !(ddsMF_FU$ID %in% c("FUT11M4", "FUG11M4", "FUL11M4"))]

##Filter the dataset, only keeping rows that have at least 10 reads total, but less than 1,000,000
keep <- rowSums(counts(ddsMF_FU)) >= 10 & rowSums(counts(ddsMF_FU)) < 1e6
ddsMF_FU <- ddsMF_FU[keep, ]

#Run the differential expression analysis
ddsMF_FU_exp <- DESeq(ddsMF_FU)
resultsNames(ddsMF_FU_exp)

```

## Invesitgate the results of the differential expression
Thanks to the multi-factor analysis we can now explore differential expression between all of the different combinations of tissues and sexes:   

  - Male Liver v. Female Liver  
  - Male Gill v. Female Gill  
  - Male Gonad v. Female Gonad   
  - All of the within sex tissue comparisons (e.g. Male Liver v. Male Gill, etc.)   

### M-F Liver Comparisson

```{r m-f-liver-results}
##Pulling out the liver M-F results with an alpha of 0.05
FU_liver_con_res <- results(ddsMF_FU_exp, 
                            contrast = c("group", "MLiver", "FLiver"), 
                            alpha = 0.05)
FU_liver_con_res$trin_geneid <- rownames(FU_liver_con_res)
head(FU_liver_con_res)

summary(FU_liver_con_res)
```

I will be classifying sex-biased genes the same way that I did for _Syngnathus floridae_ as **genes with a p-value < 0.05 AND a logFC $\ge$ |2|**. With that criteria in the liver there are `r sum(FU_liver_con_res$padj <= 0.05 & FU_liver_con_res$log2FoldChange >= 2, na.rm = TRUE)` male-biased genes and `r sum(FU_liver_con_res$padj <= 0.05 & FU_liver_con_res$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. 

I have then pulled out all of the male-biased, female-biased, and non-biased genes based on the criteria outlined above. I determined non-biased genes as a p-vaule > 0.05.

```{r liver-sex-biased}
#Removing the rows where padj. is NA in results
FU_liver_con_res_noNA <- FU_liver_con_res[!is.na(FU_liver_con_res$padj),]
summary(FU_liver_con_res_noNA) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating a vector that contains all of the male-biased and female-biased genes in the liver
FU_liver_mal_biased <- FU_liver_con_res_noNA[which(FU_liver_con_res_noNA$log2FoldChange >= 2 
                                                   & FU_liver_con_res_noNA$padj <= 0.05),]
FU_liver_fem_biased <- FU_liver_con_res_noNA[which(FU_liver_con_res_noNA$log2FoldChange <= -2 
                                                   & FU_liver_con_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the liver
FU_liver_non_biased <- FU_liver_con_res_noNA[which(FU_liver_con_res_noNA$padj > 0.05),]

```

I will be generating a table that outlines the genes that are the most male or female biased in each organ type. To do this I need to pull the top 50 differentially expressed genes in males or females, get the Trinity gene IDs and then BLAST the corresponding sequences. Here I am pulling out the Trinity gene IDs for those genes.

```{r top50-liver}
#Creating a subset of the results where the p-value is less than 0.05
FU_liver_con_res_p05 <- FU_liver_con_res_noNA[FU_liver_con_res_noNA$padj <= 0.05, ]


#Pulling the top 50 diff expressed genes in Males
top50_FU_MLiver <- head(FU_liver_con_res_p05[order(FU_liver_con_res_p05$log2FoldChange, 
                                                   decreasing = TRUE), ], 
                        n = 50)
#Run once to generate the file and then commented out
#write.table(cbind(rownames(top50_FU_MLiver)),
 #           'FU_maleL_top50TRgenes.txt', 
 #            sep = "", 
 #           quote=FALSE, 
 #           row.names = FALSE, 
 #           col.names = FALSE)


#Pulling the top 50 diff expressed genes in Females
top50_FU_Fliver <- head(FU_liver_con_res_p05[order(FU_liver_con_res_p05$log2FoldChange, 
                                                   decreasing = FALSE), ], 
                        n = 50)
#Run once to generate the file and then commented out
#write.table(cbind(rownames(top50_FU_Fliver)),
 #           'FU_femL_top50TRgenes.txt', 
 #            sep = "", 
 #           quote=FALSE, 
 #           row.names = FALSE, 
 #           col.names = FALSE)
```

### M-F Gill Comparisson

```{r m-f-gill}
##Pulling out the gill M-F results
gill_con_res_FU <- results(ddsMF_FU_exp, 
                           contrast = c("group", "MGill", "FGill"), 
                           alpha = 0.5)
gill_con_res_FU$trin_geneid <- rownames(gill_con_res_FU)
head(gill_con_res_FU)

summary(gill_con_res_FU)
```

In the gills there were `r sum(gill_con_res_FU$padj <= 0.05 & gill_con_res_FU$log2FoldChange >= 2, na.rm = TRUE)` genes that we can consider male-biased and `r sum(gill_con_res_FU$padj <= 0.05 & gill_con_res_FU$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes based on our criteria for sex-bias.

I have then pulled out all of the male-biased, female-biased, and non-biased genes to save them into their own objects.

```{r gill-sex-biased}
#Removing the rows where padj. is NA in results
FU_gill_con_res_noNA <- gill_con_res_FU[!is.na(gill_con_res_FU$padj), ]
summary(FU_gill_con_res_noNA) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating a vector that contains all of the male-biased and female-biased genes in the gills
FU_gill_mal_biased <- FU_gill_con_res_noNA[which(FU_gill_con_res_noNA$log2FoldChange >= 2 
                                                 & FU_gill_con_res_noNA$padj <= 0.05),]
FU_gill_fem_biased <- FU_gill_con_res_noNA[which(FU_gill_con_res_noNA$log2FoldChange <= -2 
                                                 & FU_gill_con_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the gills, p>0.05
FU_gill_non_biased <- FU_gill_con_res_noNA[which(FU_gill_con_res_noNA$padj > 0.05),]
```

Here I am getting the trinity gene IDs that correspond to the top 50 differentially expressed genes for males and females.

```{r top50-gill}
#Creating a subset of results where p-value is less than 0.05
FU_gill_con_res_p05 <- FU_gill_con_res_noNA[FU_gill_con_res_noNA$padj <= 0.05,]

#Pulling the top 50 diff expressed genes in Males
top50_FU_MGill <- head(FU_gill_con_res_p05[order(FU_gill_con_res_p05$log2FoldChange, 
                                                 decreasing = TRUE),], 
                       n=50)
#Run once to generate the file and then commented out
#write.table(cbind(rownames(top50_FU_MGill)),
 #           'FU_maleG_top50TRgenes.txt', 
 #           sep = "", 
 #           quote=FALSE, 
 #           row.names = FALSE, 
 #           col.names = FALSE)

#Pulling the top 50 diff expressed genes in Females
top50_FU_FGill <- head(FU_gill_con_res_p05[order(FU_gill_con_res_p05$log2FoldChange, 
                                                 decreasing = FALSE),], 
                       n=50)
#Run once to generate the file and then commented out
#write.table(cbind(rownames(top50_FU_FGill)),
 #           'FU_femG_top50TRgenes.txt', 
 #           sep = "", 
 #           quote=FALSE, 
 #           row.names = FALSE, 
 #           col.names = FALSE)
```

### M-F Gonad Comparisson

```{r m-f-gonads}
##Pulling out the gonad M-F results
gonad_con_res_FU <- results(ddsMF_FU_exp, 
                            contrast = c("group", "MGonad", "FGonad"), 
                            alpha = 0.05)
gonad_con_res_FU$trin_geneid <- rownames(gonad_con_res_FU)
head(gonad_con_res_FU)

summary(gonad_con_res_FU)
```

Between the ovaries and testis (gonads) there were `r sum(gonad_con_res_FU$padj <= 0.05 & gonad_con_res_FU$log2FoldChange >= 2, na.rm = TRUE)` genes that we can consider male-biased and `r sum(gonad_con_res_FU$padj <= 0.05 & gonad_con_res_FU$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes based on our criteria for sex-bias.

From the gonad M-F results I have then pulled out all of the male-biased, female-biased, and non-biased genes and saved them to their own objects.

```{r gonad-sex-biased}
#Removing the rows where padj. is NA in results
FU_gonad_con_res_noNA <- gonad_con_res_FU[!is.na(gonad_con_res_FU$padj), ]
summary(FU_gonad_con_res_noNA) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating an object that contains all of the male-biased and female-biased genes in the gonads
FU_gonad_mal_biased <- FU_gonad_con_res_noNA[which(FU_gonad_con_res_noNA$log2FoldChange >= 2 
                                                   & FU_gonad_con_res_noNA$padj <= 0.05),]
FU_gonad_fem_biased <- FU_gonad_con_res_noNA[which(FU_gonad_con_res_noNA$log2FoldChange <= -2 
                                                   & FU_gonad_con_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the gonads, p>0.05
FU_gonad_non_biased <- FU_gonad_con_res_noNA[which(FU_gonad_con_res_noNA$padj > 0.05),]
```

I then pulled out the trinity gene IDs that corresponded to the top 50 differentially expressed genes in males and females so that I could BLAST the sequences.

```{r top50-gonad}
#Creating a subset of the results where the p-value is less than 0.05
FU_gonad_con_res_p05 <- FU_gonad_con_res_noNA[FU_gonad_con_res_noNA$padj <= 0.05,]

#Pulling the top 50 diff expressed genes in Males
top50_FU_MGonad <- head(FU_gonad_con_res_p05[order(FU_gonad_con_res_p05$log2FoldChange, 
                                                   decreasing = TRUE),], 
                        n=50)
#Run once to generate the file and then commented out
#write.table(cbind(rownames(top50_FU_MGonad)),
 #           'FU_maleGon_top50TRgenes.txt', 
 #           sep = "", 
 #           quote=FALSE, 
 #           row.names = FALSE, 
 #           col.names = FALSE)

#Pulling the top 50 diff expressed genes in Females
top50_FU_FGonad <- head(FU_gonad_con_res_p05[order(FU_gonad_con_res_p05$log2FoldChange, 
                                                   decreasing = FALSE),], 
                        n=50)
#Run once to generate the file and then commented out
#write.table(cbind(head(top50_FU_FGonad)),
 #           'FU_femGon_top50TRgenes.txt', 
 #           sep = "", 
 #           quote=FALSE, 
 #           row.names = FALSE, 
 #           col.names = FALSE)
```

### MA Plots

```{r MA-plot-MF, echo=FALSE, fig.height= 15, fig.width=8, fig.cap="MA-plots generated for each organ type that compares logFC to the mean expression. Female-biased and Male-biased genes are represented by color (green and purple correspondingly) and are determing with a fc cutoff of 2 and a p-value cutoff of 0.05."}
liver_MA <- ggmaplot(FU_liver_con_res,
         fdr = 0.05, fc = 2,
         size = 1.4,
         top = 0,
         main = expression("Male Liver" %->% "Female Liver"),
         font.label = c("bold", 11), label.rectangle = TRUE,
         palette = c("#beaed4", "#7fc97f", "darkgray"),
         select.top.method = c("padj", "fc"),
         ggtheme = ggplot2::theme_minimal()
         )

gill_MA <- ggmaplot(gill_con_res_FU,
         fdr = 0.05, fc = 2,
         size = 1.4,
         top = 0,
         main = expression("Male Gill" %->% "Female Gill"),
         font.label = c("bold", 11), label.rectangle = TRUE,
         palette = c("#beaed4", "#7fc97f", "darkgray"),
         select.top.method = c("padj", "fc"),
         ggtheme = ggplot2::theme_minimal()
         )

gonad_MA <- ggmaplot(gonad_con_res_FU,
         fdr = 0.05, fc = 2,
         size = 1.4,
         top = 0,
         main = expression("Testis" %->% "Ovaries"),
         font.label = c("bold", 11), label.rectangle = TRUE,
         palette = c("#beaed4", "#7fc97f", "darkgray"),
         select.top.method = c("padj", "fc"),
         ggtheme = ggplot2::theme_minimal()
         )

#Merge all the plots into one
plot_grid(liver_MA, gill_MA, gonad_MA,
          ncol = 1,
          nrow = 3,
          labels = c('A', 'B', 'C'),
          label_fontfamily = 'sans',
          label_fontface = 'bold',
          label_size = 18,
          rel_heights = c(4.10, 4.10, 4.10))

```

## Variation in FC across sex-bias and tissue type
I want to create a plot the highlights the variation we see in fold-change both across the different biases groups (male-biased, female-biased, and non-biased) within one tissue type and across all of the tissue types. To do this I first need to create a "long" dataset in the following format:

| Tissue_type|     Bias      |   Fold-Change   |
|:----------:|:-------------:|:---------------:|
|    Gill    |   male_bias   |      XXXXX      |
|    Gill    |   male_bias   |      XXXXX      |
|    Gill    |   fem_bias    |      XXXXX      |
|    Gill    |   no_bias     |      XXXXX      |
|    ...     |    ....       |       ...       |
|    Liver   |   male_bias   |      XXXXX      |
|    Liver   |   male_bias   |      XXXXX      |
|    Liver   |   fem_bias    |      XXXXX      |
|    Liver   |   no_bias     |      XXXXX      |
|    ...     |    ....       |       ...       |
|   Gonad    |   male_bias   |      XXXXX      |
|   Gonad    |   male_bias   |      XXXXX      |
|   Gonad    |   fem_bias    |      XXXXX      |
|   Gonad    |   no_bias     |      XXXXX      |
|    ...     |    ....       |       ...       |

That dataset is created here, with the Trinity gene IDs included as well:

```{r logFC-long-dataset}
FU_logFC_long <- data.frame(
  tissue=c(rep("Gill",nrow(FU_gill_fem_biased)),
           rep("Gill", nrow(FU_gill_mal_biased)),
           rep("Gill", nrow(FU_gill_non_biased)),
           rep("Gonad", nrow(FU_gonad_fem_biased)),
           rep("Gonad", nrow(FU_gonad_mal_biased)),
           rep("Gonad", nrow(FU_gonad_non_biased)),
           rep("Liver", nrow(FU_liver_fem_biased)),
           rep("Liver", nrow(FU_liver_mal_biased)),
           rep("Liver", nrow(FU_liver_non_biased))
         ),
  bias=c(rep("FB",nrow(FU_gill_fem_biased)),
         rep("MB",nrow(FU_gill_mal_biased)),
         rep("NB", nrow(FU_gill_non_biased)),
         rep("FB", nrow(FU_gonad_fem_biased)),
         rep("MB", nrow(FU_gonad_mal_biased)),
         rep("NB", nrow(FU_gonad_non_biased)),
         rep("FB", nrow(FU_liver_fem_biased)),
         rep("MB", nrow(FU_liver_mal_biased)),
         rep("NB", nrow(FU_liver_non_biased))
         ),
  logFC=c(FU_gill_fem_biased$log2FoldChange,
          FU_gill_mal_biased$log2FoldChange,
          FU_gill_non_biased$log2FoldChange,
          FU_gonad_fem_biased$log2FoldChange,
          FU_gonad_mal_biased$log2FoldChange,
          FU_gonad_non_biased$log2FoldChange,
          FU_liver_fem_biased$log2FoldChange,
          FU_liver_mal_biased$log2FoldChange,
          FU_liver_non_biased$log2FoldChange
          ),
  geneID=c(rownames(FU_gill_fem_biased),
           rownames(FU_gill_mal_biased),
           rownames(FU_gill_non_biased),
           rownames(FU_gonad_fem_biased),
           rownames(FU_gonad_mal_biased),
           rownames(FU_gonad_non_biased),
           rownames(FU_liver_fem_biased),
           rownames(FU_liver_mal_biased),
           rownames(FU_liver_non_biased)
           )
  
)
```

With the dataset in the proper format now, we can generate the plot

```{r FC-var-plot, echo=FALSE, fig.cap="Absolute value of the logFC for genes that are female-biased, male-biased, and unbiased across each tissue type. Raw fold-change values are added ontop of the boxplot as jitters."}

ymax <- max(abs(FU_logFC_long$logFC),
            na.rm = TRUE) + 5
sex_bias_colors <- c("FB" = "#7fc97f", 
                     "MB" = "#beaed4", 
                     "UB" = "darkgray")
organs <- levels(as.factor(FU_logFC_long$tissue))

par(mfrow=c(1,4), 
    oma=c(4,5,2,8), 
    mar=c(1,1,1,0))

for(organ in organs){
   
   # add jittered points
   plot(abs(FU_logFC_long$logFC[FU_logFC_long$tissue==organ]) ~ 
            jitter(as.numeric(as.factor(FU_logFC_long$bias[FU_logFC_long$tissue==organ]))),
        col="#00000075", 
        axes=FALSE,
        cex.main=2,
        xlim=c(0,4),
        ylim=c(0,ymax)
        )
   
   # make the boxplot
   boxplot(abs(FU_logFC_long$logFC[FU_logFC_long$tissue==organ]) ~  
             FU_logFC_long$bias[FU_logFC_long$tissue==organ],
           col=scales::alpha(sex_bias_colors,0.75),
           add = TRUE,
           yaxt='n',
           las=1,
           cex.axis=1.75,
           frame=FALSE,
           lwd=1.5,
           outline=FALSE# do not plot outliers
           )
   
   # make the axis lines longer and thicker
   axis(1, labels=NA,
        at=-1:4,
        lwd=2, 
        lwd.ticks=0, 
        las = 3, 
        cex.axis = 1.5)
   axis(2, labels=seq(-5,ymax,10),
        line=NA, 
        at=seq(-5,ymax,10), 
        lwd=2,
        ylim=c(0,ymax),
        cex.axis=2,
        las=2)
   
   mtext(organ, cex=1.5,outer=FALSE, line=-1)
   
 }
```

There are some weird patterns popping up in this analysis. The first one is the magnitude of differences in male- and female-biased genes in the liver. This weirdness is then confirmed in the above plot (Fig. \@ref(fig:FC-var-plot)), we can see this clumping pattern showing um in the male-biased genes in the liver. There is a cluster of genes with a logFC between 5 -15 and then another clump at 25 and above, and very little in between. This may be a result of normalizing across all of the organs. I am going to try re-running the DE analysis within each organ and see if that helps anything.

## Creating an Upset Plot

```{r upset-plot-mal, echo=FALSE, fig.cap="Upset plots to show the number of shared sex-biased genes across the organs in males."}
par(mfrow=c(1,2))
#Male-biased genes
listInputMB <- list("Testis" = rownames(FU_gonad_mal_biased),
                  "Male Gill"=rownames(FU_gill_mal_biased), 
                  "Male Liver"=rownames(FU_liver_mal_biased)
                  )
upset(fromList(listInputMB),
      mainbar.y.label = "Number of Shared Male-Biased Genes",
      sets.x.label = "Total Number of Male-Biased Genes",
      point.size = 3)
```


```{r upset-plot-mal, echo=FALSE, fig.cap="Upset plots to show the number of shared sex-biased genes across the organs in females."}
#Female
listInputFB <- list("Ovaries" = rownames(FU_gonad_fem_biased),
                  "Female Gill"=rownames(FU_gill_fem_biased), 
                  "Female Liver"=rownames(FU_liver_fem_biased)
                  )
upset(fromList(listInputFB),
      mainbar.y.label = "Number of Shared Female-Biased Genes",
      sets.x.label = "Total Number of Female-Biased Genes",
      point.size = 3)
```

```{r upset-plot-all, echo=FALSE, fig.cap="Upset plots to show the number of shared sex-biased genes across the organs across both sexes."}
#Esporting data used to make the Upset plot (run once and them commented out)
#write.table(as.data.frame(gonad_mal_biased), "data/gonad_mal_biased.txt", 
 #           row.names = TRUE)
#write.table(as.data.frame(gonad_fem_biased), "data/gonad_fem_biased.txt", 
 #           row.names = TRUE)
#write.table(as.data.frame(gill_mal_biased), "data/gill_mal_biased.txt", 
 #           row.names = TRUE)
#write.table(as.data.frame(gill_fem_biased), "data/gill_fem_biased.txt", 
 #           row.names = TRUE)
#write.table(as.data.frame(liver_mal_biased), "data/liver_mal_biased.txt", 
 #           row.names = TRUE)
#write.table(as.data.frame(liver_fem_biased), "data/liver_fem_biased.txt", 
 #           row.names = TRUE)

#Checking there is no overlap between the two sexes
listInputall <- list("Testis" = rownames(FU_gonad_mal_biased),
                  "Male Gill"=rownames(FU_gill_mal_biased), 
                  "Male Liver"=rownames(FU_liver_mal_biased),
                  "Ovaries" = rownames(FU_gonad_fem_biased),
                  "Female Gill"=rownames(FU_gill_fem_biased), 
                  "Female Liver"=rownames(FU_liver_fem_biased))

upset(fromList(listInputall),
      mainbar.y.label = "Number of Shared Sex-Biased Genes",
      sets.x.label = "Total Number of Sex-Biased Genes",
      point.size = 3,
      nsets = 6,
      nintersects = NA)

```


## Categorizing sex-specific genes
Now that we have investigated what the sex-bias is like across the different tissue types I want to dive further into genes with **sex-specific expression**. These are genes expressed only in one sex or the other. I am classifying a sex-specific genes within each tissue as ones where the expression of that gene is less than 10 for all of one sex and there is a median of $\ge 20$ in the other sex. 

Prior to running the for loop, any "outliers" that were determined by DESeq were removed from the pool of genes. Additionally, normalized counts were used for the classification of sex-specific genes as DESeq2 uses the moralized counts for all of the logFC/sexbias calculations.

```{r sex-specific-for-loop}
#Pulling out the geneIDs for genes that were categorized as "outliers" by DESeq2
#Calculating the Cooks threshold that would have been used
np <- length(resultsNames(ddsMF_FU_exp))
nsamp <- ncol(ddsMF_FU_exp)
cooks_thresh <- qf(0.99, df1 = np, df2 = 30-np)

out_ids <- names(mcols(ddsMF_FU_exp)$maxCooks[mcols(ddsMF_FU_exp)$maxCooks >
                                                cooks_thresh])

#Filtering out the dds dataset to remove the outliers determined by DESeq
ddsMF_FU_exp_filtered <- ddsMF_FU_exp[!(rownames(ddsMF_FU_exp) %in% out_ids), ]

#Create a vector with the different organ types
organs <- levels(colData(ddsMF_FU_exp_filtered)$Organ)

#Create an empty list to store my datasets in
FU_sex_specific_genes <- list()

#Generate the for loop to identify MSpecific and FSpecific genes in each 
#organ based on Medians
for(organ in organs){
  
  #Male-Specific Genes
  ##Pull out all of the rows where fem count <=10 in every female sample
  fem0_organ_names <- which(rowSums(t(apply(counts(ddsMF_FU_exp_filtered, 
                                                   normalized = TRUE)[, ddsMF_FU_exp_filtered$Sex == "F" 
                                                                      & 
                                                                        ddsMF_FU_exp_filtered$Organ == organ], 
                                            1, 
                                            function(x) x <= 10)
                                      )
                                ) == ncol(counts(ddsMF_FU_exp_filtered, 
                                                 normalized = TRUE)[, ddsMF_FU_exp_filtered$Sex == "F" &
                                                                      ddsMF_FU_exp_filtered$Organ == organ])
                      )
  
  fem0_organ <- counts(ddsMF_FU_exp_filtered, 
                       normalized = TRUE)[rownames(counts(ddsMF_FU_exp_filtered, 
                                                          normalized = TRUE)) %in% 
                                            names(fem0_organ_names), 
                                          ddsMF_FU_exp_filtered$Organ == organ]
                                                         
  
  ##Pull out rows where median of male count >=20 for that organ
  mal10_organ <- apply(counts(ddsMF_FU_exp_filtered, 
                              normalized = TRUE)[, ddsMF_FU_exp_filtered$Sex == "M" 
                                                 & ddsMF_FU_exp_filtered$Organ == organ], 
                       1,
                       function(x) median(x) >=20)
  
  ##Keep only the rows where all fem samples <=10 and the Male median>=20
  fem0_mal10_organ <- fem0_organ[rownames(fem0_organ) %in% 
                                   names(mal10_organ[mal10_organ == TRUE]),
                                 ]
  
  ##Create a new object with a name based on the organ type
  organ_malsp <- sub("$", "_male_specific", organ)
  FU_sex_specific_genes[[organ_malsp]] <- fem0_mal10_organ
  
  
  
  #Female-Specific Genes
  ##Pull out all of the rows where male count <=10 in every male sample
  mal0_organ_names <- which(rowSums(t(apply(counts(ddsMF_FU_exp_filtered, 
                                                   normalized = TRUE)[, ddsMF_FU_exp_filtered$Sex == "M" 
                                                                      & 
                                                                        ddsMF_FU_exp_filtered$Organ == organ],
                                            1, 
                                            function(x) x <= 10)
                                      )
                                    ) == ncol(counts(ddsMF_FU_exp_filtered, 
                                                     normalized = TRUE)[, ddsMF_FU_exp_filtered$Sex == "M" & 
                                                                          ddsMF_FU_exp_filtered$Organ == organ])
                            )
  
  mal0_organ <- counts(ddsMF_FU_exp_filtered, 
                       normalized = TRUE)[rownames(counts(ddsMF_FU_exp_filtered, 
                                                          normalized = TRUE)) %in% 
                                            names(mal0_organ_names), 
                                          ddsMF_FU_exp_filtered$Organ == organ]
  
  ##Pull out rows where median of female count >=10 for that organ
  fem10_organ <- apply(counts(ddsMF_FU_exp_filtered, 
                              normalized = TRUE)[, ddsMF_FU_exp_filtered$Sex == "F" &
                                                   ddsMF_FU_exp_filtered$Organ == organ],
                       1,
                       function(x) median(x) >=20)
  
  #Keep only the rows where male=0 and the fem median>=10
  mal0_fem10_organ <- mal0_organ[rownames(mal0_organ) %in% 
                                   names(fem10_organ[fem10_organ == TRUE]),
                                 ]
  
  # Create a new object with a name based on the organ type
  organ_femsp <- sub("$", "_female_specific", organ)
  FU_sex_specific_genes[[organ_femsp]] <- mal0_fem10_organ
  
} 
```

### Investigating the results of the sex-specific subsetting
Let's now take a look at how many sex-specific genes we have in each tissue type:

```{r sex-specific-counts, echo=FALSE, message=FALSE, warning=FALSE}
FU_sex_specific_counts <- data.frame(tissue = rep(c("Gill", "Gonad", "Liver"), 2),
                                  sex = c(rep("M", 3),
                                          rep("F", 3)),
                                  num_genes = c(nrow(FU_sex_specific_genes$Gill_male_specific),
                                                nrow(FU_sex_specific_genes$Gonad_male_specific),
                                                nrow(FU_sex_specific_genes$Liver_male_specific),
                                                nrow(FU_sex_specific_genes$Gill_female_specific),
                                                nrow(FU_sex_specific_genes$Gonad_female_specific),
                                                nrow(FU_sex_specific_genes$Liver_female_specific))
                                  )

FU_sex_specific_counts %>% 
  group_by(tissue, sex) %>% 
  summarise("Number of Sex-specific Genes" = sum(num_genes)) %>%
  kable(caption = "Sex-specific Genes", format = "html",
        col.names = c("Tissue Type", "Sex", "Number of Sex-specific Genes")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
```

To get a better idea what is going on between the sex-specific genes vs the sex-biased genes I first determined how many overlaps there were between our sex-biased and sex-specific genes and then used plotCounts to plot the counts for each gene separately. 

In the **Male Gills** there are `r nrow(FU_gill_mal_biased[rownames(FU_gill_mal_biased) %in% rownames(FU_sex_specific_genes$Gill_male_specific),])` genes that overlap between sex-biased and sex-specific, there are `r nrow(FU_sex_specific_genes$Gonad_male_specific[rownames(FU_sex_specific_genes$Gonad_male_specific) %in% rownames(FU_gonad_mal_biased),])` overlapping in the **gonads** and `r nrow(FU_sex_specific_genes$Liver_male_specific[rownames(FU_sex_specific_genes$Liver_male_specific) %in% rownames(FU_liver_mal_biased),])` overlapping in the **liver**. For females we have `r nrow(FU_gill_fem_biased[rownames(FU_gill_fem_biased) %in% rownames(FU_sex_specific_genes$Gill_female_specific),])` overlapping sex-specific and sex-biased genes in the **gills**, `r nrow(FU_sex_specific_genes$Gonad_female_specific[rownames(FU_sex_specific_genes$Gonad_female_specific) %in% rownames(FU_gonad_fem_biased),])` genes in the **gonads**, and `r nrow(FU_sex_specific_genes$Liver_female_specific[rownames(FU_sex_specific_genes$Liver_female_specific) %in% rownames(FU_liver_fem_biased),])` genes in the **liver**.

```{r gills-sex-specific, eval = FALSE}
## Female sex-specific
fem_sp_geneIDs <- rownames(FU_sex_specific_genes$Gill_female_specific)

##Set the plotting window
par(mfrow=c(1,1))

for(gene in fem_sp_geneIDs){
  
  plotCounts(ddsMF_FU[,ddsMF_FU$Organ == 'Gill'], gene=gene, intgroup="Sex")
  
}

## Female sex-biased
gill_fem_biased_geneIDS <- rownames(FU_gill_fem_biased)

##Set the plotting window
par(mfrow=c(1,1))

for(gene in gill_fem_biased_geneIDS){
  
  plotCounts(ddsMF_FU[,ddsMF_FU$Organ == 'Gill'], gene=gene, intgroup="Sex", col= 'salmon', pch = 19)
  
}
```

## Creating categories and binning the sex-biased genes based on degree of logFC
This binned was only done on the sex-biased genes, will not have a category for the unbiased genes. The cutoffs for the different groups are as follows:

    1. Low - biased = LFC 2 - 3
    2. Medium - biased = LFC 3 - 5
    3. High - biased = LFC 5 - 10
    4. Extreme sex bias = LFC > 10

Counts of the sex-specific genes will be added on separately as they were not classified based on fold-change but rather a presence in one sex and an absence in the other sex.

```{r bin-sex-bias}
#Make a vector that contains all of the groupings
biased_bins <- c("Unbiased", "Low", "Med", "High", "Extreme", "Sex-specific")

#Create a new column in the dataset and use ifelse statements to set the category limits
#abs(logFC) was used to account for the fem-biased genes possessing negative values
FU_logFC_long$bias_cat <- ifelse(FU_logFC_long$bias == "NB",
                              biased_bins[1],
                              ifelse(abs(FU_logFC_long$logFC) >= 2 & abs(FU_logFC_long$logFC) < 3,
                                     biased_bins[2],
                                     ifelse(abs(FU_logFC_long$logFC) >= 3 & abs(FU_logFC_long$logFC) < 5,
                                            biased_bins[3],
                                            ifelse(abs(FU_logFC_long$logFC) >= 5 & abs(FU_logFC_long$logFC) < 10,
                                                   biased_bins[4],
                                                   biased_bins[5])
                                            )
                                     )
                              )

#Making sure the genes we categorized as sex-specific are labeled as sex-specific for their 
#bias cat. in the dataset
organs <- c("Gill", "Gill", "Gonad", "Gonad", "Liver", "Liver")
bias <- c("MB", "FB", "MB", "FB", "MB", "FB")

for(i in 1:length(FU_sex_specific_genes)){

  tmp <- FU_sex_specific_genes[[i]]
  tmp <- as.data.frame(tmp)
  tmp$geneID <- rownames(tmp)
  
  for(j in 1:nrow(tmp)){
    
    one_gene <- tmp[j, ]
    
    if(one_gene[["geneID"]] %in%
       FU_logFC_long[FU_logFC_long$tissue == organs[[i]] &
                  FU_logFC_long$bias == bias[[i]],"geneID"]){
       
      FU_logFC_long[FU_logFC_long$geneID == one_gene[["geneID"]] &
                   FU_logFC_long$tissue == organs[[i]] &
                   FU_logFC_long$bias == bias[[i]],
                 "bias_cat"] <- "Sex-specific"
    }else{
      
      one_gene_dat <- data.frame(matrix(ncol= ncol(FU_logFC_long),
                                        nrow=1))
      colnames(one_gene_dat) <- colnames(FU_logFC_long)
      
      one_gene_dat$tissue <- organs[[i]]
      one_gene_dat$geneID <- one_gene[["geneID"]]
      one_gene_dat$bias <- bias[[i]]
      one_gene_dat$bias_cat <- "Sex-specific"
      rownames(one_gene_dat) <- NULL
      
      FU_logFC_long <- rbind(one_gene_dat, FU_logFC_long)
      
      rownames(FU_logFC_long) <- NULL
    }
  }
 }

#Create  subset of our long dataset that does not include the non-biased genes
logFC_long_noNB <- FU_logFC_long[FU_logFC_long$bias_cat != "Unbiased",]

#Make a table to count the number of genes in each category for each organ
bias_cat_table <- table(logFC_long_noNB$bias, logFC_long_noNB$bias_cat, logFC_long_noNB$tissue)

#Add the counts of sex-specific genes to the table
bias_cat_gill <- bias_cat_table[,, "Gill"]
#write.table(bias_cat_gill, "data/bias_cat_gills.txt", row.names = TRUE)

bias_cat_gonad <- bias_cat_table[,, "Gonad"]
#write.table(bias_cat_gonad, "data/bias_cat_gonad.txt", row.names = TRUE)

bias_cat_liver <- bias_cat_table[,, "Liver"]
write.table(bias_cat_liver, "data/bias_cat_liver.txt", row.names = TRUE)

#Plot the counts for each tissue type
par(mfrow=c(1, 3))
barplot(bias_cat_gill[,biased_bins[biased_bins!="Unbiased"]], beside = TRUE, ylim = c(0, max(bias_cat_table) + 1), col = c("#7fc97f", "#beaed4"),
        main = "Gill", ylab = "Number of Genes", xlab = "Bias Category")
barplot(bias_cat_gonad[,biased_bins[biased_bins!="Unbiased"]], beside = TRUE, ylim = c(0, max(bias_cat_table) + 1), col = c("#7fc97f", "#beaed4"),
        main = "Gonad")
barplot(bias_cat_liver[,biased_bins[biased_bins!="Unbiased"]], beside = TRUE, ylim = c(0, max(bias_cat_table) + 1), col = c("#7fc97f", "#beaed4"),
        main = "Liver")
legend("topright", legend = c("Female-biased", "Male-biased"), fill = c("#7fc97f", "#beaed4"))

```

There is a weird pattern showing up in the liver where most of the male biased genes are showing an "Extreme" level of sex bias. Let's look into some of the most male-biased genes in the liver to figure out what is going on.

```{r extreme-MB-liver}
head(FU_liver_mal_biased[order(FU_liver_mal_biased$log2FoldChange, 
                                                   decreasing = TRUE), ],
     n = 20)

#Looking at the counts for those genes
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN12515_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN16238_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN9589_c0_g1" #11M2 12M1
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN5721_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN11959_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN10133_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN13524_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN3155_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN14524_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN10100_c0_g1" #15M5
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN42401_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN8496_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN61750_c0_g1" #15M5
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN9102_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN16706_c0_g1" #15M5
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN7180_c0_g1" #15M5
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN7217_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN7360_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN7306_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
counts(ddsMF_FU_exp, normalized = TRUE)[rownames(ddsMF_FU_exp) == "TRINITY_DN23892_c0_g1" #15M5 11M4
                                        , ddsMF_FU_exp$Organ == "Liver"]
```

## Re-running the MF analysis removing FUL11M4 and FUL15M5

```{r multi-factor-analysis2, message=FALSE, warning=FALSE}
##Remove individuals
ddsMF_FU2 <- ddsMF_FU[, ddsMF_FU$ID != "FUL11M4" & ddsMF_FU$ID != "FUL15M5"]

##Filter the dataset, only keeping rows that have at least 10 reads total
keep <- rowSums(counts(ddsMF_FU2)) >= 10 
ddsMF_FU2 <- ddsMF_FU2[keep, ]

#Re-Run the differential expression analysis
ddsMF_FU_exp2 <- DESeq(ddsMF_FU2)
```

### Re-run all of the above analyses to look for differences 
#### M-F Liver Comparisson

```{r m-f-liver-results2}
##Pulling out the liver M-F results with an alpha of 0.05
FU_liver_con_res2 <- results(ddsMF_FU_exp2, 
                            contrast = c("group", "MLiver", "FLiver"), 
                            alpha = 0.05)

head(FU_liver_con_res2)
summary(FU_liver_con_res2)
```

Now in the liver there are `r sum(FU_liver_con_res2$padj <= 0.05 & FU_liver_con_res2$log2FoldChange >= 2, na.rm = TRUE)` male-biased genes and `r sum(FU_liver_con_res2$padj <= 0.05 & FU_liver_con_res2$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. Much less male-biased genes compared to before.

```{r liver-sex-biased2}
#Removing the rows where padj. is NA in results
FU_liver_con_res_noNA2 <- FU_liver_con_res2[!is.na(FU_liver_con_res2$padj),]
summary(FU_liver_con_res_noNA2) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating a vector that contains all of the male-biased and female-biased genes in the liver
FU_liver_mal_biased2 <- FU_liver_con_res_noNA2[which(FU_liver_con_res_noNA2$log2FoldChange >= 2 
                                                   & FU_liver_con_res_noNA2$padj <= 0.05),]
FU_liver_fem_biased2 <- FU_liver_con_res_noNA2[which(FU_liver_con_res_noNA2$log2FoldChange <= -2 
                                                   & FU_liver_con_res_noNA2$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the liver
FU_liver_non_biased2 <- FU_liver_con_res_noNA2[which(FU_liver_con_res_noNA2$padj > 0.05),]

```

#### M-F Gill Comparisson

```{r m-f-gill2}
##Pulling out the gill M-F results
gill_con_res_FU2 <- results(ddsMF_FU_exp2, 
                           contrast = c("group", "MGill", "FGill"), 
                           alpha = 0.5)
head(gill_con_res_FU2)

summary(gill_con_res_FU2)
```

In the gills there are now `r sum(gill_con_res_FU2$padj <= 0.05 & gill_con_res_FU2$log2FoldChange >= 2, na.rm = TRUE)` genes that we can consider male-biased and `r sum(gill_con_res_FU2$padj <= 0.05 & gill_con_res_FU2$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. This is also less whn compared to all samples.

```{r gill-sex-biased2}
#Removing the rows where padj. is NA in results
FU_gill_con_res_noNA2 <- gill_con_res_FU2[!is.na(gill_con_res_FU2$padj), ]
summary(FU_gill_con_res_noNA2) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating a vector that contains all of the male-biased and female-biased genes in the gills
FU_gill_mal_biased2 <- FU_gill_con_res_noNA2[which(FU_gill_con_res_noNA2$log2FoldChange >= 2 
                                                 & FU_gill_con_res_noNA2$padj <= 0.05),]
FU_gill_fem_biased2 <- FU_gill_con_res_noNA2[which(FU_gill_con_res_noNA2$log2FoldChange <= -2 
                                                 & FU_gill_con_res_noNA2$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the gills, p>0.05
FU_gill_non_biased2 <- FU_gill_con_res_noNA2[which(FU_gill_con_res_noNA2$padj > 0.05),]
```


#### M-F Gonad Comparisson

```{r m-f-gonads2}
##Pulling out the gonad M-F results
gonad_con_res_FU2 <- results(ddsMF_FU_exp2, 
                            contrast = c("group", "MGonad", "FGonad"), 
                            alpha = 0.05)
head(gonad_con_res_FU2)

summary(gonad_con_res_FU2)
```

Between the ovaries and testis (gonads) there are now `r sum(gonad_con_res_FU2$padj <= 0.05 & gonad_con_res_FU2$log2FoldChange >= 2, na.rm = TRUE)` genes that we can consider male-biased and `r sum(gonad_con_res_FU2$padj <= 0.05 & gonad_con_res_FU2$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes, which is actually a bit more than when all samples are included.

```{r gonad-sex-biased2}
#Removing the rows where padj. is NA in results
FU_gonad_con_res_noNA2 <- gonad_con_res_FU2[!is.na(gonad_con_res_FU2$padj), ]
summary(FU_gonad_con_res_noNA2) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating an object that contains all of the male-biased and female-biased genes in the gonads
FU_gonad_mal_biased2 <- FU_gonad_con_res_noNA2[which(FU_gonad_con_res_noNA2$log2FoldChange >= 2 
                                                   & FU_gonad_con_res_noNA2$padj <= 0.05),]
FU_gonad_fem_biased2 <- FU_gonad_con_res_noNA2[which(FU_gonad_con_res_noNA2$log2FoldChange <= -2 
                                                   & FU_gonad_con_res_noNA2$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the gonads, p>0.05
FU_gonad_non_biased2 <- FU_gonad_con_res_noNA2[which(FU_gonad_con_res_noNA2$padj > 0.05),]
```

#### MA Plots

```{r MA-plot-MF2, echo=FALSE, fig.height= 15, fig.width=8, fig.cap="MA-plots generated for each organ type that compares logFC to the mean expression. Female-biased and Male-biased genes are represented by color (green and purple correspondingly) and are determing with a fc cutoff of 2 and a p-value cutoff of 0.05."}
liver_MA2 <- ggmaplot(FU_liver_con_res2,
         fdr = 0.05, fc = 2,
         size = 1.4,
         top = 0,
         main = expression("Male Liver" %->% "Female Liver"),
         font.label = c("bold", 11), label.rectangle = TRUE,
         palette = c("#beaed4", "#7fc97f", "darkgray"),
         select.top.method = c("padj", "fc"),
         ggtheme = ggplot2::theme_minimal()
         )

gill_MA2 <- ggmaplot(gill_con_res_FU2,
         fdr = 0.05, fc = 2,
         size = 1.4,
         top = 0,
         main = expression("Male Gill" %->% "Female Gill"),
         font.label = c("bold", 11), label.rectangle = TRUE,
         palette = c("#beaed4", "#7fc97f", "darkgray"),
         select.top.method = c("padj", "fc"),
         ggtheme = ggplot2::theme_minimal()
         )

gonad_MA2 <- ggmaplot(gonad_con_res_FU2,
         fdr = 0.05, fc = 2,
         size = 1.4,
         top = 0,
         main = expression("Testis" %->% "Ovaries"),
         font.label = c("bold", 11), label.rectangle = TRUE,
         palette = c("#beaed4", "#7fc97f", "darkgray"),
         select.top.method = c("padj", "fc"),
         ggtheme = ggplot2::theme_minimal()
         )

#Merge all the plots into one
plot_grid(liver_MA2, gill_MA2, gonad_MA2,
          ncol = 1,
          nrow = 3,
          labels = c('A', 'B', 'C'),
          label_fontfamily = 'sans',
          label_fontface = 'bold',
          label_size = 18,
          rel_heights = c(4.10, 4.10, 4.10))

```

#### Creating an Upset Plot

```{r upset-plot-all2, echo=FALSE, fig.cap="Upset plots to show the number of shared sex-biased genes across the organs across both sexes."}

#Checking there is no overlap between the two sexes
listInputall2 <- list("Testis" = rownames(FU_gonad_mal_biased2),
                  "Male Gill"=rownames(FU_gill_mal_biased2), 
                  "Male Liver"=rownames(FU_liver_mal_biased2),
                  "Ovaries" = rownames(FU_gonad_fem_biased2),
                  "Female Gill"=rownames(FU_gill_fem_biased2), 
                  "Female Liver"=rownames(FU_liver_fem_biased2))

upset(fromList(listInputall2),
      mainbar.y.label = "Number of Shared Sex-Biased Genes",
      sets.x.label = "Total Number of Sex-Biased Genes",
      point.size = 3,
      nsets = 6,
      nintersects = NA)

```

#### Variation in FC across sex-bias and tissue type

```{r logFC-long-dataset2}
FU_logFC_long2 <- data.frame(
  tissue=c(rep("Gill",nrow(FU_gill_fem_biased2)),
           rep("Gill", nrow(FU_gill_mal_biased2)),
           rep("Gill", nrow(FU_gill_non_biased2)),
           rep("Gonad", nrow(FU_gonad_fem_biased2)),
           rep("Gonad", nrow(FU_gonad_mal_biased2)),
           rep("Gonad", nrow(FU_gonad_non_biased2)),
           rep("Liver", nrow(FU_liver_fem_biased2)),
           rep("Liver", nrow(FU_liver_mal_biased2)),
           rep("Liver", nrow(FU_liver_non_biased2))
         ),
  bias=c(rep("FB",nrow(FU_gill_fem_biased2)),
         rep("MB",nrow(FU_gill_mal_biased2)),
         rep("NB", nrow(FU_gill_non_biased2)),
         rep("FB", nrow(FU_gonad_fem_biased2)),
         rep("MB", nrow(FU_gonad_mal_biased2)),
         rep("NB", nrow(FU_gonad_non_biased2)),
         rep("FB", nrow(FU_liver_fem_biased2)),
         rep("MB", nrow(FU_liver_mal_biased2)),
         rep("NB", nrow(FU_liver_non_biased2))
         ),
  logFC=c(FU_gill_fem_biased2$log2FoldChange,
          FU_gill_mal_biased2$log2FoldChange,
          FU_gill_non_biased2$log2FoldChange,
          FU_gonad_fem_biased2$log2FoldChange,
          FU_gonad_mal_biased2$log2FoldChange,
          FU_gonad_non_biased2$log2FoldChange,
          FU_liver_fem_biased2$log2FoldChange,
          FU_liver_mal_biased2$log2FoldChange,
          FU_liver_non_biased2$log2FoldChange
          ),
  geneID=c(rownames(FU_gill_fem_biased2),
           rownames(FU_gill_mal_biased2),
           rownames(FU_gill_non_biased2),
           rownames(FU_gonad_fem_biased2),
           rownames(FU_gonad_mal_biased2),
           rownames(FU_gonad_non_biased2),
           rownames(FU_liver_fem_biased2),
           rownames(FU_liver_mal_biased2),
           rownames(FU_liver_non_biased2)
           )
  
)
```

```{r FC-var-plot2, echo=FALSE, fig.cap="Absolute value of the logFC for genes that are female-biased, male-biased, and unbiased across each tissue type. Raw fold-change values are added ontop of the boxplot as jitters."}
par(mfrow=c(1,1))
my_colors <- c("FB" = "#7fc97f", "MB" = "#beaed4", "UB" = "darkgray")

ggplot(FU_logFC_long2,
       aes(x = bias, y = abs(logFC), fill = bias)) +
  geom_boxplot() +
  scale_fill_manual(values = my_colors) +
  facet_grid(. ~ tissue) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_point(data=FU_logFC_long2, aes(x=bias, y=abs(logFC)),
             size=0.4, 
             position = position_jitter(width = 0.15)) + 
  labs(x="Bias Level", y="|logFC|") +
  guides(fill = guide_legend(title = "Bias Level", order = 3))
```

#### Categorizing sex-specific genes

```{r sex-specific-for-loop2}
#Pulling out the geneIDs for genes that were categorized as "outliers" by DESeq2
#Calculating the Cooks threshold that would have been used
np2 <- length(resultsNames(ddsMF_FU_exp2))
nsamp2 <- ncol(ddsMF_FU_exp2)
cooks_thresh2 <- qf(0.99, df1 = np2, df2 = 28-np2)

out_ids2 <- names(mcols(ddsMF_FU_exp2)$maxCooks[mcols(ddsMF_FU_exp2)$maxCooks >
                                                cooks_thresh2])

#Filtering out the dds dataset to remove the outliers determined by DESeq
ddsMF_FU_exp_filtered2 <- ddsMF_FU_exp2[!(rownames(ddsMF_FU_exp2) %in% out_ids2), ]

#Create a vector with the different organ types
organs2 <- levels(colData(ddsMF_FU_exp_filtered2)$Organ)

#Create an empty list to store my datasets in
FU_sex_specific_genes2 <- list()

#Generate the for loop to identify MSpecific and FSpecific genes in each 
#organ based on Medians
for(organ in organs2){
  
  #Male-Specific Genes
  ##Pull out all of the rows where fem count <=10 in every female sample
  fem0_organ_names <- which(rowSums(t(apply(counts(ddsMF_FU_exp_filtered2, 
                                                   normalized = TRUE)[, ddsMF_FU_exp_filtered2$Sex == "F" 
                                                                      & 
                                                                        ddsMF_FU_exp_filtered2$Organ == organ], 
                                            1, 
                                            function(x) x <= 10)
                                      )
                                ) == ncol(counts(ddsMF_FU_exp_filtered2, 
                                                 normalized = TRUE)[, ddsMF_FU_exp_filtered2$Sex == "F" &
                                                                      ddsMF_FU_exp_filtered2$Organ == organ])
                      )
  
  fem0_organ <- counts(ddsMF_FU_exp_filtered2, 
                       normalized = TRUE)[rownames(counts(ddsMF_FU_exp_filtered2, 
                                                          normalized = TRUE)) %in% 
                                            names(fem0_organ_names), 
                                          ddsMF_FU_exp_filtered2$Organ == organ]
                                                         
  
  ##Pull out rows where median of male count >=20 for that organ
  mal10_organ <- apply(counts(ddsMF_FU_exp_filtered2, 
                              normalized = TRUE)[, ddsMF_FU_exp_filtered2$Sex == "M" 
                                                 & ddsMF_FU_exp_filtered2$Organ == organ], 
                       1,
                       function(x) median(x) >=20)
  
  ##Keep only the rows where all fem samples <=10 and the Male median>=20
  fem0_mal10_organ <- fem0_organ[rownames(fem0_organ) %in% 
                                   names(mal10_organ[mal10_organ == TRUE]),
                                 ]
  
  ##Create a new object with a name based on the organ type
  organ_malsp <- sub("$", "_male_specific", organ)
  FU_sex_specific_genes2[[organ_malsp]] <- fem0_mal10_organ
  
  
  
  #Female-Specific Genes
  ##Pull out all of the rows where male count <=10 in every male sample
  mal0_organ_names <- which(rowSums(t(apply(counts(ddsMF_FU_exp_filtered2, 
                                                   normalized = TRUE)[, ddsMF_FU_exp_filtered2$Sex == "M" 
                                                                      & 
                                                                        ddsMF_FU_exp_filtered2$Organ == organ],
                                            1, 
                                            function(x) x <= 10)
                                      )
                                    ) == ncol(counts(ddsMF_FU_exp_filtered2, 
                                                     normalized = TRUE)[, ddsMF_FU_exp_filtered2$Sex == "M" & 
                                                                          ddsMF_FU_exp_filtered2$Organ == organ])
                            )
  
  mal0_organ <- counts(ddsMF_FU_exp_filtered2, 
                       normalized = TRUE)[rownames(counts(ddsMF_FU_exp_filtered2, 
                                                          normalized = TRUE)) %in% 
                                            names(mal0_organ_names), 
                                          ddsMF_FU_exp_filtered2$Organ == organ]
  
  ##Pull out rows where median of female count >=10 for that organ
  fem10_organ <- apply(counts(ddsMF_FU_exp_filtered2, 
                              normalized = TRUE)[, ddsMF_FU_exp_filtered2$Sex == "F" &
                                                   ddsMF_FU_exp_filtered2$Organ == organ],
                       1,
                       function(x) median(x) >=20)
  
  #Keep only the rows where male=0 and the fem median>=10
  mal0_fem10_organ <- mal0_organ[rownames(mal0_organ) %in% 
                                   names(fem10_organ[fem10_organ == TRUE]),
                                 ]
  
  # Create a new object with a name based on the organ type
  organ_femsp <- sub("$", "_female_specific", organ)
  FU_sex_specific_genes2[[organ_femsp]] <- mal0_fem10_organ
  
} 
```

##### Investigating the results of the sex-specific subsetting

```{r sex-specific-counts2, echo=FALSE, message=FALSE, warning=FALSE}
FU_sex_specific_counts2 <- data.frame(tissue = rep(c("Gill", "Gonad", "Liver"), 2),
                                  sex = c(rep("M", 3),
                                          rep("F", 3)),
                                  num_genes = c(nrow(FU_sex_specific_genes2$Gill_male_specific),
                                                nrow(FU_sex_specific_genes2$Gonad_male_specific),
                                                nrow(FU_sex_specific_genes2$Liver_male_specific),
                                                nrow(FU_sex_specific_genes2$Gill_female_specific),
                                                nrow(FU_sex_specific_genes2$Gonad_female_specific),
                                                nrow(FU_sex_specific_genes2$Liver_female_specific))
                                  )

FU_sex_specific_counts2 %>% 
  group_by(tissue, sex) %>% 
  summarise("Number of Sex-specific Genes" = sum(num_genes)) %>%
  kable(caption = "Sex-specific Genes", format = "html",
        col.names = c("Tissue Type", "Sex", "Number of Sex-specific Genes")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
```

#### Creating categories and binning the sex-biased genes based on degree of logFC

```{r bin-sex-bias2}
#Make a vector that contains all of the groupings
biased_bins <- c("Unbiased", "Low", "Med", "High", "Extreme", "Sex-specific")

#Create a new column in the dataset and use ifelse statements to set the category limits
#abs(logFC) was used to account for the fem-biased genes possessing negative values
FU_logFC_long2$bias_cat <- ifelse(FU_logFC_long2$bias == "NB",
                              biased_bins[1],
                              ifelse(abs(FU_logFC_long2$logFC) >= 2 & abs(FU_logFC_long2$logFC) < 3,
                                     biased_bins[2],
                                     ifelse(abs(FU_logFC_long2$logFC) >= 3 & abs(FU_logFC_long2$logFC) < 5,
                                            biased_bins[3],
                                            ifelse(abs(FU_logFC_long2$logFC) >= 5 & abs(FU_logFC_long2$logFC) < 10,
                                                   biased_bins[4],
                                                   biased_bins[5])
                                            )
                                     )
                              )

#Making sure the genes we categorized as sex-specific are labeled as sex-specific for their 
#bias cat. in the dataset
organs <- c("Gill", "Gill", "Gonad", "Gonad", "Liver", "Liver")
bias <- c("MB", "FB", "MB", "FB", "MB", "FB")

for(i in 1:length(FU_sex_specific_genes2)){

  tmp <- FU_sex_specific_genes2[[i]]
  tmp <- as.data.frame(tmp)
  tmp$geneID <- rownames(tmp)
  
  for(j in 1:nrow(tmp)){
    
    one_gene <- tmp[j, ]
    
    if(one_gene[["geneID"]] %in%
       FU_logFC_long2[FU_logFC_long2$tissue == organs[[i]] &
                  FU_logFC_long2$bias == bias[[i]],"geneID"]){
       
      FU_logFC_long2[FU_logFC_long2$geneID == one_gene[["geneID"]] &
                   FU_logFC_long2$tissue == organs[[i]] &
                   FU_logFC_long2$bias == bias[[i]],
                 "bias_cat"] <- "Sex-specific"
    }else{
      
      one_gene_dat <- data.frame(matrix(ncol= ncol(FU_logFC_long2),
                                        nrow=1))
      colnames(one_gene_dat) <- colnames(FU_logFC_long2)
      
      one_gene_dat$tissue <- organs[[i]]
      one_gene_dat$geneID <- one_gene[["geneID"]]
      one_gene_dat$bias <- bias[[i]]
      one_gene_dat$bias_cat <- "Sex-specific"
      rownames(one_gene_dat) <- NULL
      
      FU_logFC_long2 <- rbind(one_gene_dat, FU_logFC_long2)
      
      rownames(FU_logFC_long2) <- NULL
    }
  }
 }

#Create  subset of our long dataset that does not include the non-biased genes
logFC_long_noNB2 <- FU_logFC_long2[FU_logFC_long2$bias_cat != "Unbiased",]

#Make a table to count the number of genes in each category for each organ
bias_cat_table2 <- table(logFC_long_noNB2$bias, logFC_long_noNB2$bias_cat, logFC_long_noNB2$tissue)

#Add the counts of sex-specific genes to the table
bias_cat_gill2 <- bias_cat_table2[,, "Gill"]
bias_cat_gonad2 <- bias_cat_table2[,, "Gonad"]
bias_cat_liver2 <- bias_cat_table2[,, "Liver"]


#Plot the counts for each tissue type
par(mfrow=c(1, 3))
barplot(bias_cat_gill2[,biased_bins[biased_bins!="Unbiased"]], beside = TRUE, ylim = c(0, max(bias_cat_table2) + 1), col = c("#7fc97f", "#beaed4"),
        main = "Gill", ylab = "Number of Genes", xlab = "Bias Category")
barplot(bias_cat_gonad2[,biased_bins[biased_bins!="Unbiased"]], beside = TRUE, ylim = c(0, max(bias_cat_table2) + 1), col = c("#7fc97f", "#beaed4"),
        main = "Gonad")
barplot(bias_cat_liver2[,biased_bins[biased_bins!="Unbiased"]], beside = TRUE, ylim = c(0, max(bias_cat_table2) + 1), col = c("#7fc97f", "#beaed4"),
        main = "Liver")
legend("topright", legend = c("Female-biased", "Male-biased"), fill = c("#7fc97f", "#beaed4"))

```